<!DOCTYPE html>
<html>
<head>
  <!--<meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"> -->
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>Snow Map</title>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    .esri-popup .esri-popup-header .esri-title {
      font-size: 18px;
      font-weight: bolder;
    }

    .esri-popup .esri-popup-body .esri-popup-content {
      font-size: 14px;
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.10/esri/css/main.css">
  <script src="https://js.arcgis.com/4.10/"></script>

  <!-- google ajax CDN -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"></link>
  <script>
    String.prototype.format = function () {
      var i = 0, args = arguments;
      return this.replace(/{}/g, function () {
        return typeof args[i] != 'undefined' ? args[i++] : '';
      });
    };
    function toDDM(coord){
        // Convert coordinates to DDM for map popup    
        this.convert = function(_coord){
            _coord = Math.abs(_coord);
            var degrees = Math.floor(_coord);
            var minutes = (_coord - degrees ) * 60;
            return degrees + '&deg; ' + minutes.toFixed(3) + "'";
        };
        this.lat = this.convert(coord.latitude) + (coord.latitude > 0 ? ' N' : ' S');
        this.lng = this.convert(coord.longitude) + (coord.longitude > 0 ? ' E' : ' W');
    }
    var map, view, FireCams, FireViews, FWFfeature,
        USGSTopo_url = 'https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer',
        WorldImage_url = 'https://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer',
        FSTopo_url = 'https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_FSTopo_01/MapServer',
        FSAdmin_url = 'https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_ForestSystemBoundaries_01/MapServer',
        FSTrail_url = 'https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_TrailNFSPublishForSync_01/FeatureServer/0',
        FSRoad_url = 'https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_RoadBasicForSync_01/FeatureServer/2',
        FSRec_url = 'https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_RecreationSitesOpenForSync_01/FeatureServer/0',
        USGSTransport_url = 'https://services.nationalmap.gov/arcgis/rest/services/WFS/transportation/MapServer',
        //USGSTransport_url = 'https://carto.nationalmap.gov/arcgis/rest/services/transportation/MapServer',
        FSStations_url = 'https://apps.fs.usda.gov/fsgisx02/rest/services/wo_ops_teams/S_WO_OPS_TEAMS_EU_SOI_01/FeatureServer/0',
        FireZone_url = 'https://nowcoast.noaa.gov/arcgis/rest/services/nowcoast/forecast_meteoceanhydro_pts_zones_geolinks/MapServer',
        Geomac_url = 'https://wildfire.cr.usgs.gov/arcgis/rest/services/geomac_dyn/MapServer',
        WFAS_url = "https://www.wfas.net/cgi-bin/mapserv?map=/var/www/html/nfdr/mapfiles/ndfd_geog5.map&",
        Nexrad_url = 'https://nowcoast.noaa.gov/arcgis/rest/services/nowcoast/radar_meteo_imagery_nexrad_time/MapServer',
        snow_url = "https://idpgis.ncep.noaa.gov/arcgis/rest/services/NWS_Observations/NOHRSC_Snow_Analysis/MapServer",
        SurfaceObservation_url = 'https://nowcoast.noaa.gov/arcgis/rest/services/nowcoast/obs_meteocean_insitu_sfc_time/MapServer',
        Smoke_url = 'https://idpgis.ncep.noaa.gov/arcgis/services/NWS_Forecasts_Guidance_Warnings/ndgd_smoke_sfc_1hr_avg_time/ImageServer/WMSServer?',
        NasaGibs_url = 'https://gibs-{s}.earthdata.nasa.gov/wmts/epsg3857/best/{layer}/default/{time}/{tileMatrixSet}/{z}/{y}/{x}.jpg',
        //FireCam_url = 'http://firecams.seismo.unr.edu/firecams/proxy/getptz?get=1',
        FireCam_url = 'https://firemap.sdsc.edu:5443/stations?selection=boundingBox&minLat=32.5121&minLon=-124.6509&maxLat=49&maxLon=-114.1315',
        FireCamImage = "http://api.nvseismolab.org/vulcan/v0/camera/{}/image",
        USGS_elevationQuery_url = 'https://nationalmap.gov/epqs/pqs.php?x={}&y={}&units=Feet&output=json';
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/MapImageLayer",
      "esri/layers/FeatureLayer",
      "esri/layers/GroupLayer",
      "esri/widgets/Expand",
      "esri/widgets/Legend",
      "esri/tasks/IdentifyTask",
      "esri/tasks/support/IdentifyParameters"
    ], function(
      Map, MapView, MapImageLayer, FeatureLayer, GroupLayer, Expand, Legend,
      IdentifyTask, IdentifyParameters
    ) {

      var identifyTask, params;

      // URL to the map service where the identify will be performed
      snow_url = "https://idpgis.ncep.noaa.gov/arcgis/rest/services/NWS_Observations/NOHRSC_Snow_Analysis/MapServer";

      // Add the map service as a TileLayer for fast rendering
      // Tile layers are composed of non-interactive images. For that reason we'll
      // use IdentifyTask to query the service to add interactivity to the app
      var snowLayer = new MapImageLayer({
        url: snow_url,
        opacity: 0.6,
        sublayers: [{
                id: 3,
                visible: true
            }
        ]
      });

    // USFS layers
    var road_template = {
                    title: '{ID} | {NAME}',
                    content: [{
                        type: "fields",
                        fieldInfos: [{
                                fieldName: "OPER_MAINT_LEVEL",
                                label: "OPER_MAINT_LEVEL",
                                visible: true,
                            },{
                                fieldName: "SURFACE_TYPE",
                                label: "SURFACE_TYPE",
                                visible: true
                            },{
                                fieldName: "JURISDICTION",
                                label: "JURISDICTION",
                                visible: true
                            },{
                                fieldName: "MANAGING_ORG",
                                label: "MANAGING_ORG",
                                visible: true
                            },{
                                fieldName: "OPENFORUSETO",
                                label: "OPENFORUSETO",
                                visible: true
                            },{
                                fieldName: "GIS_MILES",
                                label: "GIS_MILES",
                                visible: true
                            }]
                    }]
                }
    var trail_template = {
                    title: '{TRAIL_NO} | {TRAIL_NAME}',
                    content: [{
                        type: "fields",
                        fieldInfos: [{
                                fieldName: "TRAIL_TYPE",
                                label: "TRAIL_TYPE",
                                visible: true,
                            },{
                                fieldName: "TRAIL_CLASS",
                                label: "TRAIL_CLASS",
                                visible: true
                            },{
                                fieldName: "ALLOWED_TERRA_USE",
                                label: "ALLOWED_TERRA_USE",
                                visible: true
                            },{
                                fieldName: "MANAGING_ORG",
                                label: "MANAGING_ORG",
                                visible: true
                            },{
                                fieldName: "GIS_MILES",
                                label: "GIS_MILES",
                                visible: true
                            }]
                    }]
                }
    var FSCarto = new MapImageLayer({
        url: 'https://apps.fs.usda.gov/arcx/rest/services/wo_nfs_gstc/GSTC_IVMCartography_01/MapServer',
        id: 'FSCarto',
        title: 'Roads and Trails',
        listMode: 'hide-children',
        minScale: 400000,
        sublayers: [
            {
				id: 6,
				visible: true,
				popupEnabled: true,
				popupTemplate: road_template
            },{
				id: 5,
				visible: true,
				popupEnabled: true,
				popupTemplate: road_template
            },{
				id: 4,
				visible: true,
				popupEnabled: true,
				popupTemplate: trail_template
            },{
				id: 3,
				visible: true,
				popupEnabled: true,
				popupTemplate: trail_template
            },{
				id: 2,
				visible: true,
				popupEnabled: true,
				popupTemplate: trail_template
            }
        ]
    });

    var FSTopo = new MapImageLayer({
        url: "https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_FSTopo_01/MapServer",
        id: "FSTopo",
        title: 'FS Topo',
        minScale: 200000,
        listMode: 'hide-children',
        visible: false
    });
    var admin = new MapImageLayer({
        url: "https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_ForestSystemBoundaries_01/MapServer", // AdminBoundary
        id: "admin",
        title: 'Administrative Boundary',
        listMode: 'hide-children',
    });
    var FSOwner = FeatureLayer({
        url: 'https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_BasicOwnership_02/MapServer/0',
        id: 'FSOwner',
        title: 'Private Land',
        minScale: 400000,
        definitionExpression: "OWNERCLASSIFICATION IN ('NON-FS', 'UNPARTITIONED RIPARIAN INTEREST')",
        renderer: {
            type: "simple",
            symbol: {
                type: "simple-fill",
                style: "solid",
                color: [100, 100, 100, 1],
                outline: {
                    type: "simple-line",
                    style: "solid",
                    color: [200, 200, 200, 1],
                    width: 0.5
                }
            }
        },
        opacity: 0.3,
    });
    var FSWilderness = FeatureLayer({
        url: 'https://apps.fs.usda.gov/arcx/rest/services/wo_nfs_gstc/GSTC_IVMReference_01/MapServer/6',
        id: 'FSWilderness',
        title: 'Wilderness',
        opacity: 0.6,
        labelsVisible: false
    });
    var USFSgroup = new GroupLayer({
        title: 'US Forest Service Layers',
        id: 'USFS',
        layers: [admin, FSCarto], // FSOwner, FSWilderness, FSTopo, 
        visibilityMode: 'independent'
    });
    var map = new Map({
        basemap: "terrain",
        layers: [USFSgroup, snowLayer]
      });

    var view = new MapView({
        map: map,
        container: "viewDiv",
        center: [-120.45, 38.85],
        zoom: 9
    });

      view.when(function() {
        // Legend widget
        var legend = new Legend({
            container: document.createElement("div"),
            view: view,
            style: 'classic',//{type:'card', layout: 'stack'},
        });
        var legendExpand = new Expand({
            expandIconClass: "esri-icon-layers",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
            expandTooltip: "Legend", // optional, defaults to "Expand" for English locale
            view: view,
            expanded: true,
            content: legend.domNode
        });
        view.ui.add(legendExpand, "top-right");

        // executeIdentifyTask() is called each time the view is clicked
        view.on("click", executeIdentifyTask);

        // Create identify task for the specified map service
        identifyTask = new IdentifyTask(snow_url);

        // Set the parameters for the Identify
        params = new IdentifyParameters();
        params.tolerance = 2;
        params.layerIds = [3];
        params.layerOption = "top";
        params.width = view.width;
        params.height = view.height;
      });

      // Executes each time the view is clicked
      function executeIdentifyTask(event) {
        // Set the geometry to the location of the view click
        params.geometry = event.mapPoint;
        params.mapExtent = view.extent;
        document.getElementById("viewDiv").style.cursor = "wait";

        // This function returns a promise that resolves to an array of features
        // A custom popupTemplate is set for each feature based on the layer it
        // originates from
        identifyTask.execute(params).then(function(response) {

          var results = response.results;

          return results.map(function(result) {

            var feature = result.feature;
            var layerName = result.layerName;

            if (feature.attributes["Class value"] != 12){
              $.getJSON(USGS_elevationQuery_url.format(event.mapPoint.longitude, event.mapPoint.latitude), 
                function(data){
                  var ddm = new toDDM(event.mapPoint)
                  var elevation = data.USGS_Elevation_Point_Query_Service.Elevation_Query;
                  feature.popupTemplate = {
                    title: "Snow Depth",
                    content: "<b>{Pixel Value} inches</b> <br>Class {Class value} <br>" + 
                      "Elevation: {} {} <br>{} {}".format(elevation.Elevation.toFixed(), elevation.Units, ddm.lat, ddm.lng)
                  };
                }
              )
              feature.attributes.layerName = layerName;
              //feature.popupTemplate = { // autocasts as new PopupTemplate()
              //  title: "Snow depth",
              //  content:  "{Pixel Value} inches <br>Class {Class value}"
              //};
            } else {
              return
            }

            return feature;
          });
        }).then(showPopup); // Send the array of features to showPopup()

        // Shows the results of the Identify in a popup once the promise is resolved
        function showPopup(response) {
          if (response[0]) {
            view.popup.open({
              features: response,
              location: event.mapPoint
            });
          }
          document.getElementById("viewDiv").style.cursor = "auto";
        }
      }
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
</body>

</html>